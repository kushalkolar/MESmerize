#Overall the lightest distribution to use
dist: xenial

#required for Travis to support openCV.
services:
  - xvfb

language: python
cache: pip

#email notifications turned off for development but should be turned on during deployment
notifications:
  email: false

python:
- 3.6.7

install:
#required for tslearn to succesfully install
- pip install -q numpy Cython

script:
#Needed instead of just 'pytest' since older python versions in travis environments cause the newer pytest to exit with error 127. Will need to change the hardcoded line to UNIX variables
    # :Exit code 0: All tests were collected and passed successfully
    # :Exit code 1: Tests were collected and run but some of the tests failed
    # :Exit code 2: Test execution was interrupted by the user
    # :Exit code 3: Internal error happened while executing tests
    # :Exit code 4: pytest command line usage error
    # :Exit code 5: No tests were collected
- python -m pytest

jobs:
  #All jobs to take into the CI
  include:
    #The required environments: Linux / macOS / Windows, on which Mesmerize can run.
    - name: "Python 3.6.7 on Xenial Linux"
      python: 3.6.7
      before_install:
        - chmod +x ./scripts/travisScript.sh
      before_script:
        - python -m pip install -q -r requirements.txt
    - name: "Python 3.6.5 on macOS" #Using 3.6.5 since 3.6.7 is currently not supported
      os: osx
      osx_image: xcode9.4  # The base macOS originally running Python 3.6
      language: shell       # 'language: python' is an error on Travis CI macOS
      addons:
        homebrew:
          packages: python3.6.5  #custom install as it was found that xcode9.4 does not support python =< 3.6. Therefore manually installing the environment.
      before_install:
        - chmod +x ./scripts/travisScript.sh
        - pip3 install --progress-bar off virtualenv
        - virtualenv -p python3 ~/venv
        - source ~/venv/bin/activate
      before_script: #Manually enabling xvfb in macOS since the travis xvfb service is not supported. Still required to run openCV
        - ./scripts/travisScript.sh
        - ( sudo Xvfb :99 -ac -screen 0 1024x768x8; echo ok )
        - sleep 3 && prove -bv t
    - name: "Python 3.6.7 on Windows"
      os: windows           # Windows 10.0.17134 N/A Build 17134
      language: shell       # 'language: python' is an error on Travis CI Windows
      before_install:
        - choco install python --version 3.6.7
        - python -m pip install --upgrade pip
      before_script:
        - python -m pip install -q -r requirements.txt
        - python -m pip install -q pytest
      env: PATH=/c/Python36:/c/Python36/Scripts:$PATH

    - stage: PyPi Deployment
      if: tag IS present
      python: 3.6.7
      env:
        - DEPLOYING=true
      deploy:
        - provider: pypi
          # Your distributions here
          distributions: sdist bdist_wheel
          user: your-pypi-username
          password:
            #run 'travis encrypt your-api-token --add deploy.password' and paste the resulting key in here
            secure: secure-key-goes-here
          #After your tests ran and before the release, Travis CI will clean up any additional files and changes you made.
            skip_cleanup: true
          on:
            #The full repoName goes here e.g. 'kushalkolar/MESmerize'
            repo: repoName
            #tell Travis CI to only deploy on tagged commits
            tags: true